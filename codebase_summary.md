# エスペラント語4択クイズアプリ コードベース解説

## 概要
本アプリケーションは、**Streamlit** を用いて構築された、エスペラント語の語彙学習用Webアプリケーションです。
ユーザーは品詞や難易度別にグループ化された単語セットから4択クイズに挑戦できます。
正解時の音声再生機能や、Google Sheets をバックエンドとしたランキング機能を備えており、学習の継続を促す設計となっています。

## 主な機能

### 1. クイズシステム
- **出題形式**: 1つの正解と3つの誤答からなる4択問題。
- **グループ選択**: ユーザーは「品詞」と「グループ（難易度順）」を選択して学習を開始します。
- **出題ロジック**:
    - 同じグループ内の単語から誤答（ディストラクター）が選ばれるため、難易度が適切に保たれます。
    - 毎回ランダムに出題順が変わります。

### 2. 音声再生機能
- **発音確認**: 正解すると、その単語のエスペラント語音声が自動（または手動）で再生されます。
- **技術仕様**: 事前に `RHVoice` で生成された `.wav` ファイルを使用します。
- **プレイヤー**: 再生速度の変更やループ再生が可能で、設定はブラウザに保存されます。

### 3. スコアリングとランキング
- **得点計算**:
    - **基礎点**: 初級(x1.0)、中級(x1.5)、上級(x2.0) の難易度係数を掛け合わせます。
    - **ボーナス**: 連続正解ボーナス（ストリーク）や、最終的な正答率に応じた精度ボーナスがあります。
- **ランキング**:
    - スコアは Google Sheets の `Scores` シートに保存されます。
    - 「本日」「今月」「全期間（殿堂入り）」のランキングが表示されます。

### 4. 復習モード
- グループ終了後、間違えた問題と正解した問題の一覧を確認できます。
- 同じグループで即座に再挑戦することも可能です。

---

## アーキテクチャとファイル構成

### 1. アプリケーション本体 (`app.py`)
ユーザーインターフェースとアプリケーションロジックの中核です。
- **UI構築**: Streamlit のコンポーネントを使用し、カスタムCSSで「エスペラント・グリーン」を基調としたデザインを適用しています。
- **状態管理**: `st.session_state` を活用し、クイズの進行状況、現在のスコア、ユーザー設定（再生速度など）を保持します。
- **データ読み込み**: `st.cache_data` デコレータを使用し、語彙データの読み込みをキャッシュして高速化しています。
- **DB連携**: `st_gsheets_connection` ライブラリを使用し、Google Sheets を簡易データベースとして利用しています。

### 2. データ処理ロジック (`vocab_grouping.py`)
CSVデータを読み込み、学習に適したグループに分割するロジックを担当します。
- **入力データ**: `merged_esperanto_vocab_completed.csv`（約3000語）。
- **品詞分類**:
    - 語尾（`-o`:名詞, `-a`:形容詞, `-i`:動詞, `-e`:副詞）による自動判定。
    - 代名詞、相関詞、前置詞などは定義済みリストと照合して分類します。
- **レベル分け**:
    - `Unified_Level` カラムの値に基づき、単語をソートします。
    - 全体を **初級:中級:上級 = 55:65:120** の比率で分割します。
- **グルーピング**:
    - 各レベル内で、さらに20〜30語程度の小グループに分割します。
    - これにより、ユーザーは適度な分量で学習を進めることができます。

### 3. 音声生成スクリプト (`generate_audio.py`)
オフラインで音声ファイルを生成するためのスクリプトです。
- **合成エンジン**: `RHVoice`（音声合成ソフト）をコマンドライン経由で呼び出します。
- **ファイル管理**:
    - 特殊文字（`ĉ`, `ĝ` など）を含む単語は、ファイル名として安全な形式（`cx`, `gx` など）に変換して保存します。
    - `audio/` ディレクトリに `.wav` 形式で出力されます。

### 4. 設定とデプロイ
- **依存関係**: `requirements.txt` に必要なライブラリ（`streamlit`, `pandas`, `st-gsheets-connection` 等）が記載されています。
- **デプロイ**: Streamlit Cloud へのデプロイを想定しており、`DEPLOY.md` に Google Sheets 連携のための Secrets 設定手順が詳述されています。

---

## データフロー

1.  **起動時**: `app.py` が `vocab_grouping.py` を経由して CSV を読み込み、メモリ上でグループ構造を構築します。
2.  **クイズ開始**: ユーザーがグループを選択すると、そのグループ内の単語からランダムに問題セットが生成されます。
3.  **回答中**:
    - ユーザーが選択肢をクリックすると、正誤判定が行われます。
    - 正解なら `audio/` フォルダから対応する音声ファイルを読み込んで再生します。
    - スコア（`st.session_state`）が更新されます。
4.  **終了時**:
    - 結果画面で「スコアを保存」を押すと、Google Sheets API を通じてスコアが追記されます。
    - ランキングデータが再読み込みされ、最新の順位が表示されます。

## メンテナンスと品質管理

### 1. UIの堅牢化
Streamlit の仕様上、動的に生成されるボタン（「次へ」や選択肢）の動作が不安定になることがあるため、以下のような対策を実装しています。
- **明示的なキー付与**: `key=f"next_btn_{q_index}"` のように、状態に依存したユニークなIDを各ウィジェットに付与し、ステートの競合を防いでいます。
- **ステート管理**: `st.session_state` を広範に使用し、画面リロード（`st.rerun()`）後もユーザーの入力やクイズの進行状況が確実に保持されるようにしています。

### 2. 補助スクリプト
開発と保守のために以下のスクリプトが含まれています。
- **`verify_logic.py`**: 全単語が正しくグループ化され、重複や漏れがないかを検証するスクリプト。
- **`check_audio_gaps.py`**: 音声ファイルが存在しない単語を特定するためのチェックツール。
- **`generate_audio.py`**: 音声合成エンジン `RHVoice` を使用して、欠落している音声ファイルを一括生成するツール。

### 3. 今後の拡張性
- **`SCORE_FILE`**: 初期のローカルJSON保存の名残ですが、現在は Google Sheets (`st-gsheets-connection`) がメインの保存先となっています。
- **多言語対応**: 現在は日本語UIですが、辞書データとUIラベルを差し替えることで他言語への展開も可能な構造です。
